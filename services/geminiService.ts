
import { GoogleGenAI, Type } from "@google/genai";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const MODEL_NAME = 'gemini-3-flash-preview';

export const checkSpelling = async (text: string) => {
  const result = await ai.models.generateContent({
    model: MODEL_NAME,
    contents: `–¢—ã ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏.
    –¢–ï–ö–°–¢: "${text}"
    
    –í–µ—Ä–Ω–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫.
    –§–æ—Ä–º–∞—Ç JSON.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          correctedText: { type: Type.STRING },
          errorsFound: { type: Type.BOOLEAN },
          explanation: { type: Type.STRING, description: "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π" }
        },
        required: ["correctedText", "errorsFound", "explanation"]
      }
    }
  });
  return JSON.parse(result.text);
};

export const analyzeResponse = async (objection: string, response: string) => {
  const result = await ai.models.generateContent({
    model: MODEL_NAME,
    contents: `–¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ RBT.RU. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.
    
    –°–ò–¢–£–ê–¶–ò–Ø:
    –í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: "${objection}"
    –û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞: "${response}"
    
    –ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò (–æ—Ç 0 –¥–æ 10):
    1. Persuasiveness (–£–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å): –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏ –ø—Ä–æ–¥–∞–≤–µ—Ü –∞—Ä–≥—É–º–µ–Ω—Ç—ã –æ –≤—ã–≥–æ–¥–µ, –∫–∞—á–µ—Å—Ç–≤–µ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–µ RBT?
    2. Politeness (–í–µ–∂–ª–∏–≤–æ—Å—Ç—å): –ù–∞—Å–∫–æ–ª—å–∫–æ —Ç–æ–Ω –æ–±—â–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É?
    3. Logic (–õ–æ–≥–∏–∫–∞): –ï—Å—Ç—å –ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ —Å–≤—è–∑–∫–∞ "–°–æ–≥–ª–∞—Å–∏–µ + –ü–µ—Ä–µ—Ö–æ–¥ + –ê—Ä–≥—É–º–µ–Ω—Ç + –í–æ–ø—Ä–æ—Å"?
    4. Client Orientation (–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞): –†–µ—à–∞–µ—Ç –ª–∏ –æ—Ç–≤–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–ø–æ—Ä–∏—Ç?

    –í –ø–æ–ª–µ feedback –Ω–∞–ø–∏—à–∏:
    - üíé –¢–û–ß–ö–ê –†–û–°–¢–ê: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.
    - ‚úÖ –°–ò–õ–¨–ù–ê–Ø –°–¢–û–†–û–ù–ê: –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ö–æ—Ä–æ—à–æ.
    - üöÄ –ü–†–ò–ú–ï–† –ú–ê–°–¢–ï–†–ê: –ò–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
    
    –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. –§–æ—Ä–º–∞—Ç JSON.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          persuasiveness: { type: Type.NUMBER },
          politeness: { type: Type.NUMBER },
          logic: { type: Type.NUMBER },
          clientOrientation: { type: Type.NUMBER },
          satisfaction: { type: Type.NUMBER },
          feedback: { type: Type.STRING },
          score: { type: Type.NUMBER }
        },
        required: ["persuasiveness", "politeness", "logic", "clientOrientation", "satisfaction", "feedback", "score"]
      },
      systemInstruction: "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ —Ä–∏—Ç–µ–π–ª–µ. –¢–≤–æ–π —Å—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π."
    }
  });

  return JSON.parse(result.text);
};

export const simulateClientStep = async (history: { role: 'user' | 'model', parts: { text: string }[] }[], mood: string, productInfo: { name: string, price: string }) => {
  const result = await ai.models.generateContent({
    model: MODEL_NAME,
    contents: { parts: history.flatMap(h => h.parts) },
    config: {
      systemInstruction: `–¢—ã ‚Äî –†–ï–ê–õ–¨–ù–´–ô –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏ RBT.RU. 
      –¢–û–í–ê–†: ${productInfo.name}. –¶–ï–ù–ê: ${productInfo.price} —Ä—É–±.
      –ù–ê–°–¢–†–û–ï–ù–ò–ï: ${mood}.
      
      –õ–û–ì–ò–ö–ê –ü–û–í–ï–î–ï–ù–ò–Ø:
      - –¢—ã ‚Äî –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –±–æ—Ç. –¢–≤–æ–∏ —Ä–µ–∞–∫—Ü–∏–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã.
      - –¢–´ –°–õ–´–®–ò–®–¨ –ü–†–û–î–ê–í–¶–ê. –ï—Å–ª–∏ –æ–Ω —É–ø–æ–º—è–Ω—É–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –≥–∞—Ä–∞–Ω—Ç–∏—é –∏–ª–∏ —Å–∫–∏–¥–∫—É ‚Äî –∑–∞—Ü–µ–ø–∏—Å—å –∑–∞ —ç—Ç–æ. –°–ø—Ä–∞—à–∏–≤–∞–π "–ê –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?", "–ê —á—Ç–æ –µ—Å–ª–∏ —Å–ª–æ–º–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –≥–æ–¥?", "–≠—Ç–∞ —Å–∫–∏–¥–∫–∞ —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è?".
      - –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–≤–µ—Ü –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞—É—á–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã, —Ç—ã –Ω–∞—á–∏–Ω–∞–µ—à—å —Å–∫—É—á–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å—Å—è.
      - –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–≤–µ—Ü –ø—Ä–∏–≤–æ–¥–∏—Ç —Å–∏–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ –≤—ã–≥–æ–¥—É –≤ 2000 —Ä—É–±–ª–µ–π –∏–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É), —Ç—ã –¥–æ–ª–∂–µ–Ω —ç—Ç–æ –ø—Ä–∏–∑–Ω–∞—Ç—å: "–•–º, –Ω—É —ç—Ç–æ –∑–≤—É—á–∏—Ç —É–∂–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ...".
      - –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–Ω—è—Ç—å, —Å—Ç–æ–∏—Ç –ª–∏ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä —Å–≤–æ–∏—Ö –¥–µ–Ω–µ–≥ –∏ —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞.
      
      –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
      - –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
      - –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –Ω–æ –≤–µ–∂–ª–∏–≤—ã–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–µ—Å–ª–∏ –ø—Ä–æ–¥–∞–≤–µ—Ü –≤–µ–∂–ª–∏–≤).
      - –ó–∞–¥–∞–≤–∞–π 1 —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ—á—Ç–∏ –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ, —á—Ç–æ–±—ã –¥–∏–∞–ª–æ–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è.
      - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π "—Ä–æ–±–æ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ" —Ñ—Ä–∞–∑—ã.`
    }
  });
  return result.text;
};
